name: Deploy Fabric Workspaces CI/CD

on:
  workflow_dispatch:

jobs:
  render-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests jinja2

      - name: Set environment variables
        run: |
          echo "TENANT_ID=${{ secrets.TENANT_ID }}" >> $GITHUB_ENV
          echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> $GITHUB_ENV
          echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "CAPACITY_ID=${{ secrets.CAPACITY_ID }}" >> $GITHUB_ENV
          echo "USER_OBJECT_ID=${{ secrets.USER_OBJECT_ID }}" >> $GITHUB_ENV

      - name: Render config
        run: python scripts/render_config.py

      - name: Upload rendered config
        uses: actions/upload-artifact@v4
        with:
          name: workspace-config
          path: workspace_config.json

  deploy:
    needs: render-config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Download rendered config
        uses: actions/download-artifact@v4
        with:
          name: workspace-config

      - name: Run deployment
        run: python scripts/deploy.py
